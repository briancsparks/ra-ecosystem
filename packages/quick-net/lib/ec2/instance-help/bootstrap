#!/bin/bash -ex

echo "Bootstrap script"

pull_s3() {
  aws s3 cp "s3://${NAMESPACE_LC}/quick-net/deploy/${INSTANCE_ID}/$1" /usr/sbin
  chmod 0755 "/usr/sbin/$1"
}

# TODO: do a loop like below, but must be in sibling dir like 'files' below.
pull_s3 bootstrap-nonroot
pull_s3 untar-from-s3
pull_s3 cmd-from-s3
pull_s3 get-certs-from-s3
pull_s3 sshix
pull_s3 qn-hosts


FILES="$(aws s3api list-objects --bucket ${NAMESPACE_LC} --prefix quick-net/deploy/${INSTANCE_ID}/files | jq -r '.Contents[].Key')"

for f in $FILES; do

  untar-from-s3 "s3://${NAMESPACE_LC}/$f"

done

echo "Install clients:" > /home/ubuntu/readme.md
echo "sudo apt-get install -y redis-tools mongodb-clients" >> /home/ubuntu/readme.md
echo "" >> /home/ubuntu/readme.md

chown ubuntu:ubuntu /home/ubuntu/readme.md

