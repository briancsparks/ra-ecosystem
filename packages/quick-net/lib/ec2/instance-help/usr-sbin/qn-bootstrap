#!/bin/bash -e

echo "Bootstrap script"

# -----------------------------------------------------------------------------------------------------------------------------
# Scripts
FILES="$(aws s3api list-objects --bucket ${NAMESPACE_LC} --prefix quick-net/deploy/${INSTANCE_ID}/usr-sbin | jq -r '.Contents[].Key')"

for f in $FILES; do
  aws s3 cp "s3://${NAMESPACE_LC}/$f" /usr/sbin
  chmod 0755 "/usr/sbin/$(basename $f)"
done



# -----------------------------------------------------------------------------------------------------------------------------
# Data files (like certs)
FILES="$(aws s3api list-objects --bucket ${NAMESPACE_LC} --prefix quick-net/deploy/${INSTANCE_ID}/files | jq -r '.Contents[].Key')"

for f in $FILES; do

  qn-untar-from-s3 "s3://${NAMESPACE_LC}/$f"

done


# -----------------------------------------------------------------------------------------------------------------------------
# Put info in the `ubuntu` user home folder
echo "Install clients:" >> /home/ubuntu/readme.md
echo "sudo apt-get install -y redis-tools mongodb-clients" >> /home/ubuntu/readme.md
echo "" >> /home/ubuntu/readme.md

chown ubuntu:ubuntu /home/ubuntu/readme.md

# Turn quicknet-installed into JSON
curl -sSL 'http://169.254.169.254/latest/dynamic/instance-identity/document' > /home/ubuntu/quicknetinstdata.json
(
  echo "{";
  cat /home/ubuntu/quicknet-installed;
  echo -n '"instanceIdentity": ';
  cat /home/ubuntu/quicknetinstdata.json;
  echo "}";
)               > /home/ubuntu/quicknet-installed.json

rm /home/ubuntu/quicknet-installed

chown ubuntu:ubuntu /home/ubuntu/quicknet-installed.json
chown ubuntu:ubuntu /home/ubuntu/quicknetinstdata.json


# -----------------------------------------------------------------------------------------------------------------------------
# etcd
qn-install-etcd
