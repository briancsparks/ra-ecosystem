#!/bin/bash -e

test -f ${HOME}/bootstrap-nonroot-run && exit 0

cmd-from-s3 "s3://${NAMESPACE_LC}/quick-net/deploy/${INSTANCE_ID}/boot-shell-commands"

# We like github
ssh-keyscan github.com              >> ~/.ssh/known_hosts
ssh-keyscan github.azc.ext.hp.com   >> ~/.ssh/known_hosts

# Get Node.js modules
mkdir -p run && cd $_

git clone git@github.com:briancsparks/ra-ecosystem
cd ra-ecosystem
git checkout feature/stack

if which nginx; then
  # ---- lambda-net
  cd apps/lambda-net
  npm i

  pm2 start server.js

  # Is nginx running?
  if ps aux | egrep -v grep | egrep nginx; then
    sudo nginx -t && sudo nginx -s reload
  else
    sudo nginx -t && sudo nginx
  fi

  tree /etc/nginx

  echo "Nginx processes:"
  ps aux | egrep -v grep | egrep nginx
fi

aws s3 cp "s3://${NAMESPACE_LC}/quick-net/deploy/${INSTANCE_ID}/home/.vimrc" "$HOME/.vimrc"

echo "true" > ${HOME}/bootstrap-nonroot-run
